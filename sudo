#!/data/data/com.termux/files/usr/bin/bash

# =============================================
# SUDO FOR TERMUX - ENHANCED VERSION
# Version: 2.2
# Author: Endjustice
# Repository: https://github.com/Endjustice/deep-eating
# =============================================

# Configuration
colored=true
red=1 green=2 yellow=3 blue=4 magenta=5 cyan=6

# Logging configuration
LOG_ENABLED=false
LOG_FILE="/data/data/com.termux/files/usr/tmp/sudo.log"

# Security configuration
TIMEOUT_DURATION=30
MAX_ARGS_LENGTH=1000

# Initialize logging
init_log() {
    if [ "$LOG_ENABLED" = "true" ] && [ ! -d "$(dirname "$LOG_FILE")" ]; then
        mkdir -p "$(dirname "$LOG_FILE")" 2>/dev/null || LOG_ENABLED=false
    fi
}

# Log function
log() {
    if [ "$LOG_ENABLED" = "true" ]; then
        local timestamp=$(date '+%Y-%m-%d %H:%M:%S')
        echo "[$timestamp] $1" >> "$LOG_FILE" 2>/dev/null || true
    fi
}

# Enhanced color function
color() {
    if [ "$colored" = "true" ] && [ -t 1 ]; then
        echo "$(tput setaf $1)${*:2}$(tput sgr0)"
    else
        echo "${*:2}"
    fi
}

# Error handling function
error_exit() {
    echo -e "$(color $red "ERROR: $1")" >&2
    log "ERROR: $1"
    exit 1
}

# Warning function
warning() {
    echo -e "$(color $yellow "WARNING: $1")" >&2
    log "WARNING: $1"
}

# Info function
info() {
    echo -e "$(color $blue "INFO: $1")" >&2
    log "INFO: $1"
}

# Check if running in Termux
check_termux_environment() {
    if [ ! -d "/data/data/com.termux/files" ]; then
        error_exit "This script must be run in Termux environment"
    fi
}

show_usage() {
    echo -e "\n$(color $cyan "╔══════════════════════════════════╗")"
    echo -e "$(color $cyan "║           SUDO FOR TERMUX         ║")"
    echo -e "$(color $cyan "╚══════════════════════════════════╝")"
    echo -e "\n$(color $yellow "Usage:")"
    echo -e "  $(color $green "sudo su [-]")"
    echo -e "    Drop to root shell\n"
    echo -e "  $(color $green "sudo <command> [<args>]")"
    echo -e "    Run command as root with optional arguments\n"
    echo -e "$(color $magenta "Examples:")"
    echo -e "  sudo apt update"
    echo -e "  sudo su"
    echo -e "  sudo whoami"
    echo -e ""
    exit 0
}

# Path configurations
SYSBIN=/system/bin
SYSXBIN=/system/xbin
PRE=/data/data/com.termux/files
ROOT_HOME=$PRE/home/.suroot
BINPRE=$PRE/usr/bin
LDLP="export LD_LIBRARY_PATH=$PRE/usr/lib"
CMDLINE="PATH=$PATH:$SYSXBIN:$SYSBIN;$LDLP;HOME=$ROOT_HOME;cd $PWD"

# Enhanced SU binary finder - ONLY system paths
find_su() {
    # System SU paths - ignore Termux paths
    local system_su_paths=(
        "/sbin/su"
        "/system/bin/su"
        "/system/xbin/su"
        "/vendor/bin/su"
        "/product/bin/su"
        "/su/bin/su"
        "/magisk/.core/bin/su"
        "/data/adb/magisk/su"
        "/data/adb/ksu/bin/su"
    )
    
    info "Searching for system SU binary..."
    
    for path in "${system_su_paths[@]}"; do
        if [ -x "$path" ]; then
            info "Found system SU at: $path"
            # Test if SU actually works
            if $path -c "id" 2>/dev/null | grep -q "uid=0"; then
                info "SU binary is functional: $path"
                echo "$path"
                return 0
            else
                warning "SU binary found but not functional: $path"
            fi
        fi
    done
    
    return 1
}

# Manual SU test function
manual_su_test() {
    echo -e "$(color $yellow "Testing root access manually...")"
    
    # Test various SU commands
    local test_paths=("/sbin/su" "/system/bin/su" "/system/xbin/su" "/su/bin/su")
    
    for path in "${test_paths[@]}"; do
        if [ -x "$path" ]; then
            echo -e "$(color $blue "Trying: $path")"
            if $path -c "id" 2>/dev/null; then
                echo -e "$(color $green "SUCCESS with: $path")"
                return 0
            fi
        fi
    done
    
    echo -e "$(color $red "Manual test failed. Please check:")"
    echo -e "  1. Run 'su' manually in Termux"
    echo -e "  2. Grant root permission to Termux"
    echo -e "  3. Check if your device is properly rooted"
    return 1
}

# Validate SU binary
validate_su() {
    if [ ! -x "$SU" ]; then
        error_exit "SU binary not executable: $SU"
    fi
    
    # Test SU functionality with simple command
    if ! $SU -c "id" 2>/dev/null | grep -q "uid=0"; then
        echo -e "$(color $red "SU binary found but not functional: $SU")"
        manual_su_test
        error_exit "Cannot get root access. Please fix root permissions first."
    fi
    
    info "SU binary validated successfully: $SU"
}

# Setup root environment (simplified)
setup_root_env() {
    if [ ! -d "$ROOT_HOME" ]; then
        info "Setting up root environment..."
        
        # Try to create directory without remount first
        if ! $SU -c "mkdir -p $ROOT_HOME 2>/dev/null" || \
           ! $SU -c "chmod 700 $ROOT_HOME 2>/dev/null"; then
            warning "Failed to setup root home, continuing anyway..."
        else
            # Create basic .bashrc for root
            local bashrc_content="PS1=\"# \"\nexport TERM=$TERM\n$LDLP\nexport PATH=$PATH:$SYSXBIN:$SYSBIN"
            $SU -c "echo -e '$bashrc_content' > $ROOT_HOME/.bashrc 2>/dev/null" && \
            $SU -c "chmod 700 $ROOT_HOME/.bashrc 2>/dev/null" && \
            info "Root environment setup completed"
        fi
    fi
}

# Main function
main() {
    init_log
    check_termux_environment
    
    # Handle help
    if [ "$1" = "-h" ] || [ "$1" = "--help" ]; then
        show_usage
    fi
    
    # Find and validate SU
    SU=$(find_su)
    if [ -z "$SU" ]; then
        echo -e "\n$(color $red "No functional SU binary found!")"
        echo -e "$(color $yellow "Troubleshooting steps:")"
        echo -e "  1. Run 'su' manually in Termux"
        echo -e "  2. Make sure Termux has root permission"
        echo -e "  3. Check if your device is properly rooted"
        echo -e "  4. Try installing Magisk or SuperSU"
        echo -e ""
        manual_su_test
        exit 1
    fi
    
    validate_su
    
    # Setup environment if needed
    setup_root_env
    
    if [ $# -eq 0 ]; then
        show_usage
    fi
    
    # Handle commands
    case "$1" in
        "su")
            if [ "$2" = "-" ]; then
                CMDLINE="$CMDLINE;$BINPRE/bash -l"
            else
                CMDLINE="$CMDLINE;$BINPRE/bash"
            fi
            info "Starting root shell"
            ;;
        *)
            # Build command line for execution
            local args=$(printf '%q ' "$@")
            if [ -x "$BINPRE/$1" ]; then
                CMDLINE="$CMDLINE;$BINPRE/$args"
            elif command -v "$1" >/dev/null 2>&1; then
                CMDLINE="$CMDLINE;$args"
            else
                error_exit "Command not found: $1"
            fi
            ;;
    esac
    
    # Execute the command
    $SU -c "$CMDLINE"
}

# Run main function
main "$@"
